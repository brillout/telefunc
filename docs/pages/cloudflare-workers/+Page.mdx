import { Link, RepoLink } from '@brillout/docpress'

Using Telefunc with [Cloudflare Workers](https://workers.cloudflare.com/) for serverless edge computing.

## Overview

Telefunc works seamlessly with Cloudflare Workers, enabling you to build type-safe RPC APIs that run at the edge. You have two main options:

1. **🚀 Recommended**: <Link href="/cloudflare-vite-plugin">@cloudflare/vite-plugin</Link> - Official Cloudflare Vite plugin with workerd runtime
2. **⚙️ Manual Setup**: Traditional setup with custom build configuration

## Examples

- <RepoLink path="/examples/cloudflare-vite-plugin" /> (Recommended - uses official Cloudflare Vite plugin)
- <RepoLink path="/examples/cloudflare-workers" /> (Manual setup)

## Quick Start (Recommended)

Use the official Cloudflare Vite plugin for the best development experience:

```bash
npm install @cloudflare/vite-plugin telefunc
```

See the complete guide: <Link href="/cloudflare-vite-plugin">Cloudflare Vite Plugin Integration</Link>

## Manual Setup

If you prefer a manual setup or need more control:

1. **Install dependencies:**
   ```bash
   npm install telefunc vite wrangler
   ```

2. **Configure Vite:**
   ```js
   // vite.config.js
   import { telefunc } from 'telefunc/vite'

   export default {
     plugins: [telefunc()],
     build: { target: 'esnext' } // Required for Cloudflare Workers
   }
   ```

3. **Create your Worker:**
   ```js
   // worker/index.js
   import { telefunc } from 'telefunc'

   export default {
     async fetch(request) {
       const url = new URL(request.url)
       
       if (url.pathname.startsWith('/_telefunc')) {
         const httpResponse = await telefunc({
           url: url.pathname,
           method: request.method,
           body: await request.text()
         })
         
         return new Response(httpResponse.body, {
           status: httpResponse.statusCode,
           headers: { 'Content-Type': httpResponse.contentType }
         })
       }
       
       // Handle other requests...
     }
   }
   ```

4. **Define telefunctions:**
   ```js
   // hello.telefunc.js
   export { hello }
   
   import { shield } from 'telefunc'
   
   const hello = shield([{ name: shield.type.string }], 
     async function ({ name }) {
       return { message: `Hello ${name} from the edge!` }
     }
   )
   ```

## Cloudflare Bindings

Access Cloudflare services in your telefunctions:

```js
// api.telefunc.js
export { saveData, getData }

import { shield } from 'telefunc'

const saveData = shield([{ key: t.string, value: t.string }], 
  async function ({ key, value }, context) {
    const { env } = context
    
    // KV storage
    await env.MY_KV.put(key, value)
    
    // D1 database
    await env.MY_D1.prepare('INSERT INTO data (key, value) VALUES (?, ?)')
      .bind(key, value)
      .run()
    
    return { success: true }
  }
)

const getData = shield([{ key: t.string }], 
  async function ({ key }, context) {
    const { env } = context
    
    // Get from KV
    const value = await env.MY_KV.get(key)
    
    return { key, value }
  }
)
```

Configure bindings in `wrangler.toml`:

```toml
[[kv_namespaces]]
binding = "MY_KV"
id = "your-kv-namespace-id"

[[d1_databases]]
binding = "MY_D1"
database_name = "my-database"
database_id = "your-database-id"
```

## Development

For manual setup, you'll need a development server:

```js
// devServer.js
const express = require('express')
const { telefunc, config } = require('telefunc')

const app = express()
app.use(express.text())

// Telefunc middleware
app.all('/_telefunc', async (req, res) => {
  const httpResponse = await telefunc({
    url: req.originalUrl,
    method: req.method,
    body: req.body
  })
  res.status(httpResponse.statusCode)
     .type(httpResponse.contentType)
     .send(httpResponse.body)
})

// Vite dev middleware
const vite = await import('vite')
const viteDevMiddleware = (
  await vite.createServer({
    server: { middlewareMode: true }
  })
).middlewares
app.use(viteDevMiddleware)

app.listen(3000)
```

## Deployment

```bash
# Build your application
npm run build

# Deploy to Cloudflare
wrangler deploy
```

## Benefits

- **🌍 Global Edge Network**: Your APIs run close to users worldwide
- **⚡ Zero Cold Start**: Instant response times
- **💰 Cost Effective**: Pay only for what you use
- **🔧 Rich Ecosystem**: Access to KV, D1, R2, Durable Objects, and more
- **🛡️ Built-in Security**: DDoS protection and security features included

## Comparison: Vite Plugin vs Manual

| Feature | @cloudflare/vite-plugin | Manual Setup |
|---------|------------------------|--------------|
| Development Runtime | ✅ workerd (matches production) | ❌ Node.js (different from production) |
| Setup Complexity | ✅ Simple | ❌ Complex |
| Hot Reloading | ✅ Full HMR support | ⚠️ Limited |
| Cloudflare Bindings | ✅ Native support | ⚠️ Manual configuration |
| Build Process | ✅ Integrated | ❌ Manual |
| Maintenance | ✅ Official support | ❌ Self-maintained |

**Recommendation**: Use <Link href="/cloudflare-vite-plugin">@cloudflare/vite-plugin</Link> for new projects.

## Learn More

- <Link href="/cloudflare-vite-plugin">Cloudflare Vite Plugin Integration</Link>
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Wrangler CLI Documentation](https://developers.cloudflare.com/workers/wrangler/)
