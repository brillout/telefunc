import { Link, CodeBlockTransformer } from '@brillout/docpress'
import { Tab, Tabs, TabList, TabPanel } from 'react-tabs'
import '../../components/tabs.css'

**Environment**: server.

`getContext()` enables telefunctions to access contextual information.

```ts
// TodoList.telefunc.ts
// Environment: server

import { getContext } from 'telefunc'

export async function onLoad() {
  const context = getContext()
  const { user } = context
  const todoItems = await Todo.findMany({ select: 'text', authorId: user.id })
  return {
    todoItems,
    userName: user.name
  }
}
```

It's most commonly used for implementing permissions, see <Link href="/permissions" />.


## Provide

Before you can use `getContext()`, you must provide the `context` object to your Telefunc server middleware, see:
- <Link href="/server" />
- <Link href="/telefunc" />

For example:

<Tabs>
  <TabList>
    <Tab>Hono</Tab>
    <Tab>Express.js</Tab>
  </TabList>
  <TabPanel>

```ts
// server/index.ts
// Environment: server

// Server entry (Hono)

import { Hono } from 'hono'
import { telefunc } from 'telefunc'

const app = new Hono()

app.all('/_telefunc', async (c) => {
  const httpResponse = await telefunc({
    request: c.req.raw,
    // We provide the context object here:
    context: {
      user: c.get('user')
    }
  })
  return new Response(httpResponse.body, {
    status: httpResponse.statusCode,
    headers: { 'content-type': httpResponse.contentType }
  })
})

// Some authentication middleware — sets the user on Hono's context
app.use(async (c, next) => {
  const userId = c.req.cookie('user-id')
  const user = await getUserFromDatabase(userId)

  // Or using a third-party authentication provider (e.g. Auth0):
  // @docpress-replace user2 user
  const user2 = await authProviderApi.getUser(c.req.headers)

  // Authentication middlewares usually provide information
  // about the logged-in user on the context object:
  c.set('user', user)
  await next()
})
```
> See also:
> - [Hono Guides > Middleware > Extending the Context in Middleware](https://hono.dev/docs/guides/middleware#extending-the-context-in-middleware)

  </TabPanel>
  <TabPanel>

```ts
// server/index.ts
// Environment: server

// Server entry (Express.js)

import express from 'express'
import { telefunc } from 'telefunc'

const app = express()

// Telefunc middleware
app.all('/_telefunc', async (req: Request, res: Response) => {
  // Authentication middlewares (e.g. Passport.js or Grant) usually provide information
  // about the logged-in user on the `req` object:
  const user = req.user

  // Or when using a third-party authentication provider (e.g. Auth0):
  // @docpress-replace user2 user
  const user2 = await authProviderApi.getUser(req.headers)

  const httpResponse = await telefunc({
    // We provide the context object here:
    context: {
      user
    },
    url: req.url,
    method: req.method,
    body: req.body
  })

  const { body, statusCode, contentType } = httpResponse
  res.status(statusCode).type(contentType).send(body)
})
```

  </TabPanel>
</Tabs>

## Access

If you get this error:

<CodeBlockTransformer lineBreak="break-word">
```
[telefunc][Wrong Usage][getContext()] Cannot access context object, see https://telefunc.com/getContext#access
```
</CodeBlockTransformer>

Then this means that `getContext()` was called after an `await` operator:

```ts
// TodoList.telefunc.ts

export async function myTelefunction() {
  await something()
  // ❌ Bad: we should call getContext() before `await something()`
  const context = getContext()
}
```

Make sure to call `getContext()` before any `await` operators:

```ts
// TodoList.telefunc.ts

export async function myTelefunction() {
  // ✅ Good: we call getContext() before `await`
  const context = getContext()
  await something()
}
```


## TypeScript

We can use `Telefunc.Context` to globally set the type of `const context = getContext()`:

```ts ts-only
// TelefuncContext.d.ts

import 'telefunc'
import type { User } from './User.ts'

declare module 'telefunc' {
  namespace Telefunc {
    interface Context {
      user: null | User
    }
  }
}
```
```ts ts-only
// User.ts

export type User = { id: number }
```
```ts ts-only
// *.telefunc.ts

import { getContext } from 'telefunc'

export async function someTelefunction() {
  // TypeScript knows that `user.id` is a `number`
  const { user } = getContext()
}
```

We can also directly set `const context = getContext<MyContext>()`:

```ts ts-only
// *.telefunc.ts

import { getContext } from 'telefunc'

type Context = {
  userId: number
}

export async function someTelefunction() {
  // TypeScript knows that `userId` is a `number`
  const { userId } = getContext<Context>()
}
```

## See also

- <Link href="/server" />
- <Link href="/getContext" />
