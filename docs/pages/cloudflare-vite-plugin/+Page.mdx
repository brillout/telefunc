import { Link, RepoLink } from '@brillout/docpress'

Using Telefunc with [Cloudflare's official Vite plugin](https://developers.cloudflare.com/workers/vite-plugin/) for seamless Cloudflare Workers development.

## Overview

The `@cloudflare/vite-plugin` provides a full-featured integration between Vite and the Cloudflare Workers runtime. When combined with Telefunc, you get:

- **Workers Runtime Development**: Your code runs in workerd during development, matching production behavior
- **Type-safe RPC**: Telefunc provides type-safe remote procedure calls
- **Hot Module Replacement**: Fast development iteration with Vite's HMR
- **Cloudflare Bindings**: Direct access to KV, D1, R2, and other Cloudflare services
- **Automatic Integration**: Telefunc automatically detects and integrates with the Cloudflare plugin

## Example

- <RepoLink path="/examples/cloudflare-vite-plugin" />

## Quick Start

1. **Install dependencies:**
   ```bash
   npm install @cloudflare/vite-plugin telefunc
   ```

2. **Configure Vite:**
   ```ts
   // vite.config.ts
   import { defineConfig } from 'vite'
   import { cloudflare } from '@cloudflare/vite-plugin'
   import { telefunc } from 'telefunc/vite'

   export default defineConfig({
     plugins: [
       cloudflare({
         entry: './src/worker.ts',
         dev: { runtime: 'workerd' }
       }),
       telefunc()
     ]
   })
   ```

3. **Create your Worker:**
   ```ts
   // src/worker.ts
   import { telefunc } from 'telefunc'

   export default {
     async fetch(request: Request, env: Env, ctx: ExecutionContext) {
       const url = new URL(request.url)
       
       // Handle Telefunc RPC calls
       if (url.pathname.startsWith('/_telefunc')) {
         const httpResponse = await telefunc({
           url: url.pathname,
           method: request.method,
           body: await request.text(),
           context: { env, ctx } // Pass Cloudflare environment
         })
         
         return new Response(httpResponse.body, {
           status: httpResponse.statusCode,
           headers: { 'Content-Type': httpResponse.contentType }
         })
       }
       
       // Handle other requests...
     }
   }
   ```

4. **Define telefunctions:**
   ```ts
   // src/api.telefunc.ts
   export { getGreeting }
   
   import { shield } from 'telefunc'
   
   const getGreeting = shield([{ name: shield.type.string }], 
     async function ({ name }, context) {
       const { env } = context as { env: CloudflareEnv }
       
       // Access Cloudflare bindings
       // await env.MY_KV.get('some-key')
       
       return { message: `Hello ${name} from Cloudflare Workers!` }
     }
   )
   ```

## Cloudflare Bindings

Access Cloudflare services through the context parameter:

```ts
// Configure bindings in wrangler.toml
[[kv_namespaces]]
binding = "MY_KV"
id = "your-kv-namespace-id"

[[d1_databases]]
binding = "MY_D1"
database_name = "my-database"
database_id = "your-database-id"
```

```ts
// Use bindings in telefunctions
const saveData = shield([{ key: t.string, value: t.string }], 
  async function ({ key, value }, context) {
    const { env } = context as { env: CloudflareEnv }
    
    // KV storage
    await env.MY_KV.put(key, value)
    
    // D1 database
    const result = await env.MY_D1.prepare('SELECT * FROM users').all()
    
    return { success: true, users: result.results }
  }
)
```

## Development vs Production

- **Development**: Uses workerd runtime via `@cloudflare/vite-plugin`
- **Production**: Deploys to Cloudflare Workers with identical runtime

This ensures complete consistency between development and production environments.

## Automatic Integration

Telefunc automatically detects when `@cloudflare/vite-plugin` is present and:

- ✅ Configures build settings for Cloudflare Workers compatibility
- ✅ Sets up proper module externalization
- ✅ Ensures ES module output format
- ✅ Integrates with the Workers development environment

## Commands

```bash
# Development with workerd runtime
npm run dev

# Build for production
npm run build

# Preview production build locally
npm run preview

# Deploy to Cloudflare
npm run deploy
```

## Benefits

1. **Seamless Development**: No proxy servers or complex setups needed
2. **Type Safety**: Full TypeScript support across client and server
3. **Performance**: Optimized builds with tree-shaking and code splitting
4. **Cloudflare Native**: Direct access to all Cloudflare services
5. **Hot Reloading**: Fast development with Vite's HMR
6. **Production Parity**: Development environment matches production exactly

## Migration from Manual Setup

If you're currently using a manual Cloudflare Workers setup with Telefunc:

1. Install `@cloudflare/vite-plugin`
2. Update your `vite.config.ts` to use the Cloudflare plugin
3. Move your worker code to use the plugin's entry point
4. Remove manual development server setup
5. Update build scripts to use Vite's build process

The Telefunc integration will automatically adapt to work with the new setup.

## Learn More

- [Cloudflare Vite Plugin Documentation](https://developers.cloudflare.com/workers/vite-plugin/)
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- <Link href="/cloudflare-workers">Cloudflare Workers Overview & Manual Setup</Link>
